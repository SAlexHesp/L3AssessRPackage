
# install.packages("C:/~/L3Assess_0.1.0.tar.gz", source = TRUE, repos=NULL)
# install.packages("C:/~/WAFishBiology_0.1.0.tar.gz", source = TRUE, repos=NULL)
# library(devtools)
# devtools::install_github("SAlexHesp/L3AssessRPackage", build_vignettes=TRUE, force=TRUE)

rm(list=ls())
library(L3Assess)

# Simulate data
set.seed(123)
SampleSize=5000 # sample size for retained catches (and same number for released fish, if an MLL is specified)
set.seed(123)
MaxAge = 40
TimeStep = 1 # model timestep (e.g. 1 = annual, 1/12 = monthly)
NatMort = 4.22/MaxAge
FishMort = 0.1
MaxLen = 1400
LenInc = 20
MLL=NA # (minimum legal length) # retention set to 1 for all lengths if MLL set to NA and retention parameters not specified
SelectivityType=2 # 1=selectivity inputted as vector, 2=asymptotic logistic selectivity curve
SelectivityVec = NA # selectivity vector
SelParams = c(350, 50) # L50, L95-L50 for gear selectivity
RetenParams = c(500, 10) # L50, L95-L50 for retention
DiscMort = 0.5 # proportion of fish that die due to natural mortality
GrowthCurveType = 1 # 1 = von Bertalanffy, 2 = Schnute
Linf = c(900,1100)
vbK = c(0.1,0.1)
CVSizeAtAge = c(0.05,0.05)
GrowthParams = data.frame(Linf=Linf, vbK=vbK)
RefnceAges = NA
SimRes=SimLenAndAgeFreqData(SampleSize, MaxAge, TimeStep, NatMort, FishMort, MaxLen, LenInc, MLL, SelectivityType,
                         SelParams, RetenParams, SelectivityVec, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, CVSizeAtAge)




# plot data
PlotOpt=0 # 0=all plots, 1=retained lengths at age, 2=retained plus discarded lengths at age, 3=length frequency, 4=age frequency
PlotSimLenAndAgeFreqData(MaxAge, MaxLen, SimRes, PlotOpt)


# Fit combined growth curve for the two sexes
lbnd=SimRes$lbnd
midpt=SimRes$midpt
ubnd=SimRes$ubnd
ObsRetCatchFreqAtLen = SimRes$ObsRetCatchFreqAtLen # 1 sex
ObsRetCatchFreqAtLengthAndAge = as.matrix(SimRes$ObsRetCatchFreqAtLengthAndDecAge) # 1 sex
InitFishMort = 0.3 # specify starting parameters
InitL50 = 320
InitDelta = 50 # L95-L50
InitLinf = 800
InitvbK = 0.2
InitCVSizeAtAge = 0.05
InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform (so F is always between 0 and 1)
params = c(InitFishMort_logit, log(c(InitL50, InitDelta, InitLinf, InitvbK, InitCVSizeAtAge)))
FittedRes=GetAgeAndLengthBasedCatchCurveResults(params, RefnceAges, MLL, GrowthCurveType, SelectivityType, ObsRetCatchFreqAtLen, ObsRetCatchFreqAtLengthAndAge,
                                                lbnd, ubnd, midpt, SelectivityVec, DiscMort, MaxAge, NatMort, TimeStep)
FittedRes$ParamEst
# Estimate lw_95%CL up_95%CL
# FMort     0.102    0.096    0.109
# SelL50  499.940  496.564  503.338
# Delta    10.725    7.647   15.040
# Linf    953.139  937.727  968.805
# vbK       0.110    0.107    0.113
# CV        0.075    0.073    0.077
par(mfrow=c(1,1))
PlotAgeLengthCatchCurve_Growth(params, RefnceAges, MLL, GrowthCurveType, SelectivityType, ObsRetCatchFreqAtLen, ObsRetCatchFreqAtLengthAndAge,
                               lbnd, ubnd, midpt, SelectivityVec, DiscMort, MaxAge, NatMort, TimeStep, MainLabel=NA,
                               xaxis_lab=NA, yaxis_lab=NA, xmax=40, xint=10,
                               ymax=1400, yint=200, PlotCLs=TRUE, FittedRes, nReps=200)



# fit length-based catch curve to simulated data. First, fitting to just retained fish.
ObsRetCatchFreqAtLen = SimRes$ObsRetCatchFreqAtLen
ObsDiscCatchFreqAtLen = NA # vector including mean and sd
PropReleased = NA # proportion of fish released, vector including mean and sd (option probably now obselete)
midpt=SimRes$midpt
lbnd=SimRes$lbnd
ubnd=SimRes$ubnd
InitFishMort = 0.25 # specify starting parameters
InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform
InitL50 = 450
InitDelta = 50
DiscMort = 0 # ignore discard mortality
params = c(InitFishMort_logit, log(InitL50), log(InitDelta))
FittedRes=GetLengthBasedCatchCurveResults(params, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen,
                                          lbnd, ubnd, midpt, SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMort, TimeStep)
FittedRes$ParamEst
# Estimate lw_95%CL up_95%CL
# FMort        0.107    0.099    0.115
# L50_sel    500.387  497.357  503.437
# Delta_sel   11.173    8.354   14.943

PlotLengthBasedCatchCurve_RetCatch(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt,
                                   SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams,
                                   RefnceAges, MaxAge, NatMort, TimeStep, MainLabel=NA,
                                   xaxis_lab=NA, yaxis_lab=NA, xmax=1500, xint=500,
                                   ymax=0.15, yint=0.05, PlotCLs=TRUE, FittedRes, nReps=200)

PlotLengthBasedCatchCurve_Selectivity(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt, SelectivityVec,
                                      PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges,
                                      MaxAge, NatMort, TimeStep, MainLabel=NA, xaxis_lab=NA, yaxis_lab=NA, xmax=1200, xint=200,
                                      ymax=1.0, yint=0.2, PlotCLs=TRUE, FittedRes, nReps=200)


# fit length-based catch curve to simulated data. Second, fitting to both retained + discarded fish.
ObsRetCatchFreqAtLen = SimRes$ObsRetCatchFreqAtLen
ObsDiscCatchFreqAtLen = SimRes$ObsDiscCatchFreqAtLen
InitFishMort = 0.25 # specify starting parameters
InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform
InitL50 = 350
InitDelta = 50
InitL502 = 450
InitDelta2 = 50
DiscMort = 0.5 # account for discard mortality
params = c(InitFishMort_logit, log(InitL50), log(InitDelta), log(InitL502), log(InitDelta2))
FittedRes=GetLengthBasedCatchCurveResults(params, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen,
                                          lbnd, ubnd, midpt, SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMort, TimeStep)
FittedRes$ParamEst
# FMort        0.107    0.100    0.115
# L50_sel    347.395  343.101  351.743
# Delta_sel   47.681   41.955   54.188
# L50_ret    499.382  498.099  500.669
# Delta_ret   10.174    8.938   11.582

# par(mfrow=c(1,1))
# PlotLengthBasedCatchCurve_DiscCatch(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt,
#                                     SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, MaxAge, NatMort, TimeStep, MainLabel=NA,
#                                     xaxis_lab=NA, yaxis_lab=NA, xmax=1500, xint=500,
#                                     ymax=0.15, yint=0.05, PlotCLs=TRUE, FittedRes, nReps=200)
# 
# PlotLengthBasedCatchCurve_RetCatch(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt,
#                                    SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams,
#                                    RefnceAges, MaxAge, NatMort, TimeStep, MainLabel=NA,
#                                    xaxis_lab=NA, yaxis_lab=NA, xmax=1500, xint=500,
#                                    ymax=0.15, yint=0.05, PlotCLs=TRUE, FittedRes, nReps=200)
# 
# PlotLengthBasedCatchCurve_Selectivity(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt, SelectivityVec,
#                                       PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges,
#                                       MaxAge, NatMort, TimeStep, MainLabel=NA, xaxis_lab=NA, yaxis_lab=NA, xmax=1200, xint=200,
#                                       ymax=1.0, yint=0.2, PlotCLs=TRUE, FittedRes, nReps=200)
# 
# PlotLengthBasedCatchCurve_Mortality(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt, SelectivityVec,
#                                     PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges,
#                                     MaxAge, NatMort, TimeStep, xmax=NA, xint=NA, ymax=NA, yint=NA, FittedRes)


MaxModelAge <- 50 # maximum age considered by model, years
nLenCl = length(midpt)
tzero <- c(0, 0) # years - von Bertalanffy growth model parameters - Females, males
GrowthParams = data.frame(Linf=Linf, vbK=vbK, tzero=tzero)
lenwt_a <- 0.000005 # combined sexes - weight (g) vs length (mm, TL) relationship parameters
ln_lenwt_a <- NA # for log-log relationship
lenwt_b <- 3 # combined sexes - weight (g) vs length (mm, TL) relationship parameters
WLrel_Type <- 1 # 1=power, 2=log-log relationship
EstWtAtLen <- data.frame(EstFemWtAtLen=NA,
                         EstMalWtAtLen=NA) # weight at length, inputted as values in data frame
ReprodScale <- 1 # 1=default (standard calculations for spawning biomass), 2=hyperallometric reproductive scaling with female mass (i.e. BOFFF effects)
ReprodPattern <- 1 # 1 = gonochoristic (separate sexes), 2 = protogynous (female to male sex change), 3 = protandrous (male to female sex change)
InitRatioFem <- 0.5 # Ratio of females to males at recruitment age/length
FinalSex_Pmax <- NA # Logistic sex change relationship parameters (max probability of final sex)
FinalSex_L50 <- NA # Logistic sex change relationship parameters (inflection point)
FinalSex_L95 <- NA # Logistic sex change relationship parameters (95% of max probability)
mat_L50 <- c(250, 250) # females, males - Logistic length (mm) at maturity relationship parameters
mat_L95 <- c(300, 300) # females, males - Logistic length (mm) at maturity relationship parameters
EstMatAtLen <- data.frame(EstFemMatAtLen=NA,
                          EstMalMatAtLen=NA) # maturity at length, inputted as values in data frame
sel_L50 <- rep(SelParams[1],2) # females, males - Logistic length selectivity relationship parameters
sel_L95 <- rep(SelParams[1]+SelParams[2],2) # females, males - Logistic length selectivity relationship parameters
ret_Pmax <- c(1.0, 1.0) # maximum retention, values lower than 1 imply discarding of fish above MLL
ret_L50 <- rep(RetenParams[1],2) # females, males - Logistic fish retention at length parameters
ret_L95 <- rep(RetenParams[1]+RetenParams[2],2) # females, males - Logistic fish retention at length parameters
DiscMort <- 0 # discard mortality (e.g. 50% released fish die = 0.5)
Steepness <- 1 # steepness parameter of the Beverton and Holt stock-recruitment relationship
SRrel_Type <- 1 # 1 = Beverton-Holt, 2=Ricker
Current_F = 0
Output_Opt = 2 # 1=standard output, 2=with added length and weight outputs (slower)

Res=GetPerRecruitResults_LB(MaxModelAge, TimeStep, lbnd, ubnd, midpt, nLenCl, GrowthCurveType, GrowthParams,
                            RefnceAges, CVSizeAtAge, lenwt_a, ln_lenwt_a, lenwt_b, WLrel_Type,
                            EstWtAtLen, ReprodScale, ReprodPattern, InitRatioFem, FinalSex_Pmax, FinalSex_L50,
                            FinalSex_L95, mat_L50, mat_L95, EstMatAtLen, sel_L50, sel_L95, ret_Pmax,
                            ret_L50, ret_L95, DiscMort, Steepness, SRrel_Type, NatMort, Current_F, Output_Opt)
Res$Fem_SPR
Res$Eq_FemRelSpBiom
# > Res$Fem_SPR
# [1] 0.9988208
# > Res$Eq_FemRelSpBiom
# [1] 0.9987136

# Estimate SPR at F=M
Linf = c(900,1100)
vbK = c(0.1,0.1)
tzero = c(0,0)
CVSizeAtAge = c(0.05,0.05)
GrowthParams = data.frame(Linf=Linf, vbK=vbK, tzero=tzero)
Res=GetPerRecruitResults_LB(MaxModelAge, TimeStep, lbnd, ubnd, midpt, nLenCl, GrowthCurveType, GrowthParams,
                            RefnceAges, CVSizeAtAge, lenwt_a, ln_lenwt_a, lenwt_b, WLrel_Type,
                            EstWtAtLen, ReprodScale, ReprodPattern, InitRatioFem, FinalSex_Pmax, FinalSex_L50,
                            FinalSex_L95, mat_L50, mat_L95, EstMatAtLen, sel_L50, sel_L95, ret_Pmax,
                            ret_L50, ret_L95, DiscMort, Steepness, SRrel_Type, NatMort, Current_F, Output_Opt)
Res$Fem_SPR
Res$Eq_FemRelSpBiom
# > Res$Fem_SPR
# [1] 0.4445517
# > Res$Eq_FemRelSpBiom
# [1] 0.4445517

# Estimate SPR at F=M, but don't allow for sexually dimporphic growth
# get parameters for combined growth curve
Current_F = NatMort
Linf = FittedRes$ParamEst[4,1]
vbK = FittedRes$ParamEst[5,1]
tzero = 0
GrowthParams = c(Linf, vbK, tzero)
Res=GetPerRecruitResults_LB(MaxModelAge, TimeStep, lbnd, ubnd, midpt, nLenCl, GrowthCurveType, GrowthParams,
                            RefnceAges, CVSizeAtAge, lenwt_a, ln_lenwt_a, lenwt_b, WLrel_Type,
                            EstWtAtLen, ReprodScale, ReprodPattern, InitRatioFem, FinalSex_Pmax, FinalSex_L50,
                            FinalSex_L95, mat_L50, mat_L95, EstMatAtLen, sel_L50, sel_L95, ret_Pmax,
                            ret_L50, ret_L95, DiscMort, Steepness, SRrel_Type, NatMort, Current_F, Output_Opt)
Res$Fem_SPR
Res$Eq_FemRelSpBiom
# > Res$Fem_SPR
# [1] 0.4167061
# > Res$Eq_FemRelSpBiom
# [1] 0.4167061

# Estimate Brel, i.e. allow for effects of fishing on recruitment (and sexually dimorphic growth), at F=M
Linf = c(900,1100)
vbK = c(0.1,0.1)
tzero = c(0,0)
CVSizeAtAge = c(0.05,0.05)
GrowthParams = data.frame(Linf=Linf, vbK=vbK, tzero=tzero)
Steepness <- 0.75 # steepness parameter of the Beverton and Holt stock-recruitment relationship
Res=GetPerRecruitResults_LB(MaxModelAge, TimeStep, lbnd, ubnd, midpt, nLenCl, GrowthCurveType, GrowthParams,
                            RefnceAges, CVSizeAtAge, lenwt_a, ln_lenwt_a, lenwt_b, WLrel_Type,
                            EstWtAtLen, ReprodScale, ReprodPattern, InitRatioFem, FinalSex_Pmax, FinalSex_L50,
                            FinalSex_L95, mat_L50, mat_L95, EstMatAtLen, sel_L50, sel_L95, ret_Pmax,
                            ret_L50, ret_L95, DiscMort, Steepness, SRrel_Type, NatMort, Current_F, Output_Opt)
Res$Fem_SPR
Res$Eq_FemRelSpBiom
# > Res$Fem_SPR
# [1] 0.4485414
# > Res$Eq_FemRelSpBiom
# [1] 0.3984088

# Estimate Brel, allowing for sexually dimorphic growth and discard mortality, at F=M
DiscMort <- 0.5 # discard mortality (e.g. 50% released fish die = 0.5)
Res=GetPerRecruitResults_LB(MaxModelAge, TimeStep, lbnd, ubnd, midpt, nLenCl, GrowthCurveType, GrowthParams,
                            RefnceAges, CVSizeAtAge, lenwt_a, ln_lenwt_a, lenwt_b, WLrel_Type,
                            EstWtAtLen, ReprodScale, ReprodPattern, InitRatioFem, FinalSex_Pmax, FinalSex_L50,
                            FinalSex_L95, mat_L50, mat_L95, EstMatAtLen, sel_L50, sel_L95, ret_Pmax,
                            ret_L50, ret_L95, DiscMort, Steepness, SRrel_Type, NatMort, Current_F, Output_Opt)
Res$Fem_SPR
Res$Eq_FemRelSpBiom
# > Res$Fem_SPR
# [1] 0.385003
# > Res$Eq_FemRelSpBiom
# [1] 0.3290942

# Estimate Brel, allowing for sexually dimorphic growth, discard mortality, and reproductive scaling, at F=M
ReprodScale <- 1.8
Res=GetPerRecruitResults_LB(MaxModelAge, TimeStep, lbnd, ubnd, midpt, nLenCl, GrowthCurveType, GrowthParams,
                            RefnceAges, CVSizeAtAge, lenwt_a, ln_lenwt_a, lenwt_b, WLrel_Type,
                            EstWtAtLen, ReprodScale, ReprodPattern, InitRatioFem, FinalSex_Pmax, FinalSex_L50,
                            FinalSex_L95, mat_L50, mat_L95, EstMatAtLen, sel_L50, sel_L95, ret_Pmax,
                            ret_L50, ret_L95, DiscMort, Steepness, SRrel_Type, NatMort, Current_F, Output_Opt)
Res$Fem_SPR
Res$Eq_FemRelSpBiom
# > Res$Fem_SPR
# [1] 0.2647775
# > Res$Eq_FemRelSpBiom
# [1] 0.1979391

# compare expected catch length compositions
# unfished
Res=GetPerRecruitResults_LB(MaxModelAge, TimeStep, lbnd, ubnd, midpt, nLenCl, GrowthCurveType, GrowthParams,
                            RefnceAges, CVSizeAtAge, lenwt_a, ln_lenwt_a, lenwt_b, WLrel_Type,
                            EstWtAtLen, ReprodScale, ReprodPattern, InitRatioFem, FinalSex_Pmax, FinalSex_L50,
                            FinalSex_L95, mat_L50, mat_L95, EstMatAtLen, sel_L50, sel_L95, ret_Pmax,
                            ret_L50, ret_L95, DiscMort, Steepness, SRrel_Type, NatMort, Current_F, Output_Opt)

PlotPerRecruit_ExpCatchSizeDistns_LB(MaxModelAge, TimeStep, lbnd, ubnd, midpt, nLenCl, GrowthCurveType, GrowthParams,
                                     RefnceAges, CVSizeAtAge, lenwt_a, ln_lenwt_a, lenwt_b, WLrel_Type,
                                     EstWtAtLen, ReprodScale, ReprodPattern, InitRatioFem, FinalSex_Pmax, FinalSex_L50,
                                     FinalSex_L95, mat_L50, mat_L95, EstMatAtLen, sel_L50, sel_L95, ret_Pmax,
                                     ret_L50, ret_L95, DiscMort, Steepness, SRrel_Type, NatMort, Current_F, Res, PlotOpt,
                                     xmax=0.5, xint=0.1)
