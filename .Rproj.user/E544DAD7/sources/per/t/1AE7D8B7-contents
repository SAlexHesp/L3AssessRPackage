
# For Brett Crisafulli 
# Alex Hesp 5/4/2023

# Example code for 4 alternative length-based catch curve models, fitted to simulated data,
# generated specifying known selectivity and retention parameters.

# install.packages("C:/~/L3Assess_0.1.0.tar.gz", source = TRUE, repos=NULL)
rm(list=ls())
library(L3Assess)

# ********************
# Simulate length data
# ********************

# simulate length composition data, specifying both selectivity and retention parameters (with retention parameters close to MLL)

MaxAge = 25 # setting a bit higher than max age
TimeStep = 1/2 # model timestep (e.g. 1 = annual, 1/12 = monthly)
NatMort = 4.22/19 # 0.2221053
MaxLen = 1000
LenInc = 20
MLL = 300
SelectivityType=2 # 1=selectivity inputted as vector, 2=asymptotic logistic selectivity curve
SelectivityVec = NA
GrowthCurveType = 1 # 1 = von Bertalanffy, 2 = Schnute
Linf = c(561,588)
vbK = c(0.14,0.17)
CVSizeAtAge = c(0.05,0.05)
GrowthParams = data.frame(Linf=Linf, vbK=vbK, CVSizeAtAge=CVSizeAtAge)
RefnceAges = NA
SelParams = c(200, 300) # L50, L95 for gear selectivity
RetenParams = c(290, 310) # L50, L95 for retention
FishMort = NatMort
DiscMort = 0.5
SampleSize = c(10000,2000) # retained, discarded fish
Res=SimLenAndAgeFreqData(SampleSize, MaxAge, TimeStep, NatMort, FishMort, MaxLen, LenInc, MLL, SelectivityType,
                         SelParams, RetenParams, SelectivityVec, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, CVSizeAtAge)

Res$RetAtLength
Res$DiscCatchAtLen

ObsRetCatchFreqAtLen = Res$ObsRetCatchFreqAtLen
ObsDiscCatchFreqAtLen = Res$ObsDiscCatchFreqAtLen
lbnd = Res$lbnd
midpt = Res$midpt
ubnd = Res$ubnd
# check sample sizes and plot data
sum(ObsRetCatchFreqAtLen)
sum(ObsDiscCatchFreqAtLen)
plot(midpt,ObsRetCatchFreqAtLen,"o", ylim=c(0,2500))
points(midpt,ObsDiscCatchFreqAtLen,"o", col=2)
points(midpt,ObsDiscCatchFreqAtLen+ObsRetCatchFreqAtLen,"o", col=3)


# ****************
# Fit model type I
# ****************
# Fit model, setting retention to 1, such that selectivity is becomes the same as retention 
# (inputting size data for retained fish only, not specifying an MLL).

SelectivityType=2 # 1=selectivity inputted as vector, 2=asymptotic logistic selectivity curve
ObsRetCatchFreqAtLen = Res$ObsRetCatchFreqAtLen
ObsDiscCatchFreqAtLen = NA
MLL = NA
InitFishMort = 0.5 # specify starting parameters
InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform
InitL50_sel = 200
InitDelta_sel = 20
PropReleased = NA
params = c(InitFishMort_logit, log(InitL50_sel), log(InitDelta_sel))



FittedRes=GetLengthBasedCatchCurveResults(params, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen,
                                          lbnd, ubnd, midpt, SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, 
                                          MaxAge, NatMort, TimeStep)

FittedRes$ParamEst
# True parameters used to simulate data
# FishMort = 0.2221053
# SelParams = c(200, 300) # L50, L95 for gear selectivity
# RetenParams = c(290, 310) # L50, L95 for retention

# Now the 'selectivity', as would be estimated by the LB-SPR method, for example, match the retention parameters
# specified to simulate the data, as all fish are assumed to be retained (by not specifying an MLL)


# *****************
# Fit model type II
# *****************

# Fit model, estimating gear selectivity, setting knife-edge retention at MLL 
# (inputting size data for retained fish only, and specifying an MLL).

ObsRetCatchFreqAtLen = Res$ObsRetCatchFreqAtLen
ObsDiscCatchFreqAtLen = NA
MLL = 300
InitFishMort = 0.5 # specify starting parameters
InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform
InitL50_sel = 200
InitDelta_sel = 20
PropReleased = NA
params = c(InitFishMort_logit, log(InitL50_sel), log(InitDelta_sel))
FittedRes=GetLengthBasedCatchCurveResults(params, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen,
                                          lbnd, ubnd, midpt, SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMort, TimeStep)

FittedRes$ParamEst
# True parameters used to simulate data
# FishMort = 0.2221053
# SelParams = c(200, 300) # L50, L95 for gear selectivity

# Results not reliable for this species, as insufficient information in data to estimate selectivity, 
# whilst specifying retention for this species. 

# If this model cannot retrieve parameters for some of the other species, then this method could be dropped, as not useful

# ******************
# Fit model type III
# ******************

# Today, I've added the option to simultaneously estimate both the selectivity and retention parameters, rather than having to
# specify retention as knife-edged at the MLL. This method I think is probably preferable to the previous most similar option 
# where selectivity is estimated, but retention is set, assumed to be knife edged.

# Fit model, estimating selectivity and retention parameters (inputting size data for retained and released fish).
# Note, MLL not needed in this case, so won't do anything if specified.
ObsRetCatchFreqAtLen = Res$ObsRetCatchFreqAtLen
ObsDiscCatchFreqAtLen = Res$ObsDiscCatchFreqAtLen
MLL = NA
InitFishMort = 0.5 # specify starting parameters
InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform
InitL50_sel = 200
InitDelta_sel = 20
InitL50_ret = 300
InitDelta_ret = 20
PropReleased = NA
params = c(InitFishMort_logit, log(InitL50_sel), log(InitDelta_sel), log(InitL50_ret), log(InitDelta_ret))
FittedRes=GetLengthBasedCatchCurveResults(params, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen,
                                          lbnd, ubnd, midpt, SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMort, TimeStep)
FittedRes$ParamEst
# True parameters used to simulate data
# FishMort = 0.2221053
# SelParams = c(200, 300) # L50, L95 for gear selectivity
# RetenParams = c(290, 310) # L50, L95 for retention

PlotLengthBasedCatchCurve_Mortality(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt, SelectivityVec,
                                    PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges,
                                    MaxAge, NatMort, TimeStep, xmax=NA, xint=NA, ymax=NA, yint=NA, FittedRes)

PlotLengthBasedCatchCurve_Selectivity(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt, SelectivityVec,
                                      PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges,
                                      MaxAge, NatMort, TimeStep, MainLabel=NA, xaxis_lab=NA, yaxis_lab=NA, xmax=1200, xint=200,
                                      ymax=1.0, yint=0.2, PlotCLs=T, FittedRes, nReps=20)

PlotLengthBasedCatchCurve_RetCatch(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt,
                                   SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, MaxAge, NatMort, TimeStep, MainLabel=NA,
                                   xaxis_lab=NA, yaxis_lab=NA, xmax=700, xint=100,
                                   ymax=0.3, yint=0.05, PlotCLs=T, FittedRes, nReps=20)

PlotLengthBasedCatchCurve_DiscCatch(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt,
                                    SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, MaxAge, NatMort, TimeStep, MainLabel=NA,
                                    xaxis_lab=NA, yaxis_lab=NA, xmax=1500, xint=500,
                                    ymax=0.3, yint=0.05, PlotCLs=T, FittedRes, nReps=20)



# *****************
# Fit model type IV
# *****************

# To compare with option III, here is the previous model, when specifying retention as knife edged a the MLL, and estimating 
# gear selectivity parameters.

# Fit model, estimating selectivity and retention parameters (inputting size data for retained and released fish).
# Note, MLL not needed in this case, so won't do anything if specified.
# Suggest no longer using this option.

ObsRetCatchFreqAtLen = Res$ObsRetCatchFreqAtLen
ObsDiscCatchFreqAtLen = Res$ObsDiscCatchFreqAtLen
MLL = 300
InitFishMort = 0.5 # specify starting parameters
InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform
InitL50_sel = 200
InitDelta_sel = 20
PropReleased = NA
params = c(InitFishMort_logit, log(InitL50_sel), log(InitDelta_sel))
FittedRes=GetLengthBasedCatchCurveResults(params, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen,
                                          lbnd, ubnd, midpt, SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMort, TimeStep)
FittedRes$ParamEst
# True parameters used to simulate data
# FishMort = 0.2221053
# SelParams = c(200, 300) # L50, L95 for gear selectivity
# RetenParams = c(290, 310) # L50, L95 for retention

PlotLengthBasedCatchCurve_Mortality(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt, SelectivityVec,
                                    PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges,
                                    MaxAge, NatMort, TimeStep, xmax=NA, xint=NA, ymax=NA, yint=NA, FittedRes)

PlotLengthBasedCatchCurve_Selectivity(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt, SelectivityVec,
                                      PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges,
                                      MaxAge, NatMort, TimeStep, MainLabel=NA, xaxis_lab=NA, yaxis_lab=NA, xmax=1200, xint=200,
                                      ymax=1.0, yint=0.2, PlotCLs=T, FittedRes, nReps=20)

PlotLengthBasedCatchCurve_RetCatch(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt,
                                   SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, MaxAge, NatMort, TimeStep, MainLabel=NA,
                                   xaxis_lab=NA, yaxis_lab=NA, xmax=700, xint=100,
                                   ymax=0.3, yint=0.05, PlotCLs=T, FittedRes, nReps=20)

PlotLengthBasedCatchCurve_DiscCatch(params, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt,
                                    SelectivityVec, PropReleased, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, MaxAge, NatMort, TimeStep, MainLabel=NA,
                                    xaxis_lab=NA, yaxis_lab=NA, xmax=1500, xint=500,
                                    ymax=0.3, yint=0.05, PlotCLs=T, FittedRes, nReps=20)



