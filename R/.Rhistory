MLL=NA # (minimum legal length) # retention set to 1 for all lengths if MLL set to NA and retention parameters not specified
SelectivityType=2 # 1=selectivity inputted as vector, 2=asymptotic logistic selectivity curve
SelectivityAtLen = NA # selectivity vector
DiscMort = 0 # proportion of fish that die due to natural mortality
# single sex, von Bertalanffy
GrowthCurveType = 1 # 1 = von Bertalanffy, 2 = Schnute
Linf = 1136
vbK = 0.12
CVSizeAtAge = 0.02 # *** given short time step, reduced a bit
GrowthParams = c(Linf, vbK)
RefnceAges = NA
FishMort = 0.67*NatMort #0.67*NatMort #1.5*NatMort
PropReleased = NA
SelParams = c(200, 50)
Ret_95 = Linf*0.5
Ret_Delta = 50
RetenParams = c(Ret_95-Ret_Delta, Ret_Delta)
# generate line fishing data
MLL=NA
SampleSize = 5000 # sample size is for retained fish
Res_line=SimLenAndAgeFreqData_EqMod(SampleSize, MaxAge, TimeStep, NatMort, FishMort, MaxLen, LenInc, MLL, SelectivityType, SelParams, RetenParams, SelectivityAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, CVSizeAtAge)
lendat_line = Res_line$ObsRetCatchFreqAtLen
lendat_line2 = Res_line$ObsDiscCatchFreqAtLen
# generate BRUV data using the parameters above
MLL=NA
Res_bruv=SimLenAndAgeFreqData_EqMod(SampleSize, MaxAge, TimeStep, NatMort, FishMort, MaxLen, LenInc, MLL, SelectivityType, SelParams, RetenParams, SelectivityAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, CVSizeAtAge)
# check growth
par(mfrow=c(2,2))
plot(Res_bruv$ObsDecAgeRetCatch, Res_bruv$ObsRandLenRetCatch, xlim=c(0,40), ylim=c(0,1400))
points(Res_bruv$ObsDecAgeDiscCatch, Res_bruv$ObsRandLenDiscCatch, col="grey")
lendat_bruv1 = Res_bruv$ObsRetCatchFreqAtLen # Retained by line fishing
lendat_bruv2 = Res_bruv$ObsDiscCatchFreqAtLen # Fish that are selected but then discarded, what we would see on the stereo-BRUVs
lendat_bruv3 = lendat_bruv1 + lendat_bruv2
# line data
plot(midpt, lendat_bruv1, "l")
lines(midpt, lendat_bruv2, "l")
lines(midpt, lendat_bruv3, "l", col="blue")
# Fit to simulated line data
ObsRetCatchFreqAtLen  = lendat_line
DistnType = 1 # 1 = Multinomial, 2 = Dirichlet multinomial
ObsDiscCatchFreqAtLen = NA # (or set to Res$ObsDiscCatchFreqAtLen)
RetenAtLen = NA
PropReleased=NA
MLL=NA
# Set selectivity (retention paramaters) for line fishing
InitL50 = 500
InitDelta = 25
InitFishMort = 0.25 # specify starting parameters
InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform
params = c(InitFishMort_logit, log(InitL50), log(InitDelta))
FittedRes_line=GetLengthBasedCatchCurveResults(params, DistnType, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt, SelectivityAtLen, RetenAtLen, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMort, TimeStep)
FittedRes_line$ParamEst
# Estimate lw_95%CL up_95%CL
# FMort        0.082    0.074    0.091
# L50_sel    518.564  514.172  522.993
# Delta_sel   50.499   44.469   57.346
# true retention params
# RetenParams
# [1] 518  50
# True Fmort
# FishMort = 0.67*NatMort
# [1] 0.0804
# for BRUV sampling, obviously, no fish are retained or discarded. But depending on its size,
# a fish has a certain probability of being retained by a fisher if caught by line, and also,
# of being seen by a BRUV given its size.
# So, effectively, can separate fish into two categories, 1) fish observed by the BRUV gear but would
# be discarded if caught by line, and 2) fish observed by the BRUV gear and would be retained if caught by line
# Will suggest how to do this in a minute, but first, check that catch curve returns expected results
# if we do it
# Fit LBCC to simulated stereo-BRUV data
# inputting data for discarded and retained catches, and estimating gear selectivity, retention parameters, and F
# For now, don't have a method that whereby retention curve can be specified and just estimate selectivity parameters,
# so need to re-estimate retention parameters
ObsRetCatchFreqAtLen  = lendat_bruv1 # Retained "catch"
ObsDiscCatchFreqAtLen = lendat_bruv2 # Discarded "catch
InitL50 = 200 # selectivity of the stereo-BRUVs
InitDelta = 25 # selectivity of the stereo-BRUVs
InitL502 = 500 # retention param
InitDelta2 = 25 # retention param
params = c(InitFishMort_logit, log(InitL50), log(InitDelta), log(InitL502), log(InitDelta2))
FittedRes=GetLengthBasedCatchCurveResults(params, DistnType, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen,
lbnd, ubnd, midpt, SelectivityAtLen, RetenAtLen, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMort, TimeStep)
FittedRes$ParamEst
# Estimate lw_95%CL up_95%CL
# FMort        0.085    0.077    0.093
# L50_sel    203.513  198.521  208.631
# Delta_sel   47.124   39.589   56.094
# L50_ret    517.446  514.682  520.224
# Delta_ret   50.054   45.973   54.496
# now, method to separate BRUV data into the 2 categories
# get retention curve
L50_Ret = FittedRes_line$ParamEst[2,1] # Here saying that "retention" is the fish that get caught by the fishing gear so where mortality would be applied
L95_Ret =  FittedRes_line$ParamEst[3,1] + L50_Ret
RetenAtLen = 1 / (1+exp(-log(19)*(midpt-L50_Ret)/(L95_Ret-L50_Ret)))
# BRUV data containing fish of all sizes observed by the gear - lendat_bruv3
# expand out lengths in BRUV data
nLenCl = length(midpt)
BRUVlengths <- rep(midpt,lendat_bruv3)
# head(BRUVlengths)
# tail(BRUVlengths)
# randomly assign each fish to one of 2 categories, 1=retained, 2=discarded (i.e. if those fish were to be subsequently caught by line),
# i.e. what you would do with your 'real', observed bruv data
FishCat = rep(NA,length(BRUVlengths))
ObsRetCatchFreqAtLen <- rep(0,nLenCl)
ObsDiscCatchFreqAtLen <- rep(0,nLenCl)
for (i in 1:length(BRUVlengths)) {
randnum = runif(1,0,1)
FishLenCl = which(midpt==BRUVlengths[i])
if (randnum <= RetenAtLen[FishLenCl]) {
ObsRetCatchFreqAtLen[FishLenCl] =   ObsRetCatchFreqAtLen[FishLenCl] + 1
} else {
ObsDiscCatchFreqAtLen[FishLenCl] =   ObsDiscCatchFreqAtLen[FishLenCl] + 1
}
}
# compare randomly-assigned data, to known frequencies for each category, from simulation model,
# to check that random assignment method is reliable
par(mfrow=c(2,2),mar=c(4,3,2,2))
plot(midpt, lendat_bruv1, "l") # original - separated out in simulation
lines(midpt, ObsRetCatchFreqAtLen, col="blue") # randomly assignedm from combined samples in simulation
plot(midpt, lendat_bruv2, "l") # retained
lines(midpt, ObsDiscCatchFreqAtLen, col="blue")
# ObsRetCatchFreqAtLen  = lendat_bruv1 # Retained "catch"
# ObsDiscCatchFreqAtLen = lendat_bruv2 # Discarded "catch
ObsRetCatchFreqAtLen = lendat_bruv1 + lendat_bruv2
plot(midpt, ObsRetCatchFreqAtLen, "l") # total
plot(midpt, RetenAtLen, "l")
InitL50 = 200 # selectivity of the stereo-BRUVs
InitDelta = 25 # selectivity of the stereo-BRUVs
params = c(InitFishMort_logit, log(InitL50), log(InitDelta), log(InitL502), log(InitDelta2))
FittedRes=GetLengthBasedCatchCurveResults(params, DistnType, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen,
lbnd, ubnd, midpt, SelectivityAtLen, RetenAtLen, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMort, TimeStep)
RetenAtLen
ObsRetCatchFreqAtLen
params
library(L3Assess)
as.expression(Fest), L50est, L95est)
library(L3Assess)
# Simulate data from Multinomial distribution (single sex)
set.seed(123)
MinAge = 1
MaxAge = 40
Ages = MinAge:MaxAge
NatMort <- exp(1.46 - (1.01 * (log(MaxAge)))) # i.e. Hoenig's (1983) eqn for fish
FMort = 0.1
ZMort = FMort + NatMort
SelA50 = 6
SelA95 = 8
SampleSize = 1000 # required sample size. For 2 sex model, same sample size generated for each sex.
Res=SimAgeFreqData_EqMod(SampleSize, MinAge, MaxAge, SelA50, SelA95, NatMort, FMort)
ObsAgeFreq = unlist(as.vector(Res$CatchSample)) # input as vector for single sex model
# Simulate data from Multinomial distribution (single sex)
set.seed(123)
MinAge = 1
MaxAge = 40
Ages = MinAge:MaxAge
NatMort <- exp(1.46 - (1.01 * (log(MaxAge)))) # i.e. Hoenig's (1983) eqn for fish
FMort = 0.1
ZMort = FMort + NatMort
SelA50 = 6
SelA95 = 8
SampleSize = 1000 # required sample size. For 2 sex model, same sample size generated for each sex.
Res=SimAgeFreqData_EqMod(SampleSize, MinAge, MaxAge, SelA50, SelA95, NatMort, FMort)
ObsAgeFreq = unlist(as.vector(Res$CatchSample)) # input as vector for single sex model
# Specify catch curve model and required inputs for that model
CatchCurveModel = 1 # Chapman Robson
NatMort = NA # Chapman Robson
RecAssump = 1 # Chapman Robson
MinFreq = NA # Chapman Robson
# CatchCurveModel = 3 # Logistic selectivity
# RecAssump = NA # Logistic selectivity
# NatMort = 0.104 # Logistic selectivity
# MinFreq = NA # # Logistic selectivity
# Init_FMort = 0.2
# Init_SelA50 = 5
# Init_SelDelta = 2
# params = log(c(Init_FMort, Init_SelA50, Init_SelDelta))
# res=GetLogisticCatchCurveResults(params, NatMort, Ages, ObsAgeFreq)
# res$ParamEst
PlotAgeBasedCatchCurveResults_NormalSpace(RecAssump, SpecRecAge=NA, MinFreq, MinAge, MaxAge, NatMort,
ObsAgeFreq, CatchCurveModel, MainLabel=NA,
xaxis_lab=NA, yaxis_lab=NA, xmax=NA, xint=NA,
ymax=NA, yint=NA, PlotCLs=T)
# Simulate data from Multinomial distribution (single sex)
set.seed(123)
MinAge = 2
MaxAge = 40
Ages = MinAge:MaxAge
NatMort <- exp(1.46 - (1.01 * (log(MaxAge)))) # i.e. Hoenig's (1983) eqn for fish
FMort = 0.1
ZMort = FMort + NatMort
SelA50 = 6
SelA95 = 8
SampleSize = 1000 # required sample size. For 2 sex model, same sample size generated for each sex.
Res=SimAgeFreqData_EqMod(SampleSize, MinAge, MaxAge, SelA50, SelA95, NatMort, FMort)
ObsAgeFreq = unlist(as.vector(Res$CatchSample)) # input as vector for single sex model
# Specify catch curve model and required inputs for that model
CatchCurveModel = 1 # Chapman Robson
NatMort = NA # Chapman Robson
RecAssump = 1 # Chapman Robson
MinFreq = NA # Chapman Robson
# CatchCurveModel = 3 # Logistic selectivity
# RecAssump = NA # Logistic selectivity
# NatMort = 0.104 # Logistic selectivity
# MinFreq = NA # # Logistic selectivity
# Init_FMort = 0.2
# Init_SelA50 = 5
# Init_SelDelta = 2
# params = log(c(Init_FMort, Init_SelA50, Init_SelDelta))
# res=GetLogisticCatchCurveResults(params, NatMort, Ages, ObsAgeFreq)
# res$ParamEst
PlotAgeBasedCatchCurveResults_NormalSpace(RecAssump, SpecRecAge=NA, MinFreq, MinAge, MaxAge, NatMort,
ObsAgeFreq, CatchCurveModel, MainLabel=NA,
xaxis_lab=NA, yaxis_lab=NA, xmax=NA, xint=NA,
ymax=NA, yint=NA, PlotCLs=T)
# MinAge = 2
# MaxAge = 40
# Ages = MinAge:MaxAge
# NatMort <- exp(1.46 - (1.01 * (log(MaxAge)))) # i.e. Hoenig's (1983) eqn for fish
# FMort = 0.1
# ZMort = FMort + NatMort
# SelA50 = 6
# SelA95 = 8
# SampleSize = 1000 # required sample size. For 2 sex model, same sample size generated for each sex.
# Res=SimAgeFreqData_EqMod(SampleSize, MinAge, MaxAge, SelA50, SelA95, NatMort, FMort)
ObsAgeFreq = unlist(as.vector(Res$CatchSample)) # input as vector for single sex model
ObsAgeFreq
library(L3Assess)
# Simulate data from Multinomial distribution (single sex)
set.seed(123)
MinAge = 2
MaxAge = 40
Ages = MinAge:MaxAge
NatMort <- exp(1.46 - (1.01 * (log(MaxAge)))) # i.e. Hoenig's (1983) eqn for fish
FMort = 0.1
ZMort = FMort + NatMort
SelA50 = 6
SelA95 = 8
SampleSize = 1000 # required sample size. For 2 sex model, same sample size generated for each sex.
Res=SimAgeFreqData_EqMod(SampleSize, MinAge, MaxAge, SelA50, SelA95, NatMort, FMort)
ObsAgeFreq = unlist(as.vector(Res$CatchSample)) # input as vector for single sex model
# Specify catch curve model and required inputs for that model
ObsAgeFreq = as.vector(unlist(Res$CatchSample))
res=GetChapmanRobsonMortalityResults(RecAssump=1, SpecRecAge=NA, MinAge, MaxAge, ObsAgeFreq)
# Specify catch curve model and required inputs for that model
plot(ObsAgeFreq)
res=GetChapmanRobsonMortalityResults(RecAssump=NA, SpecRecAge=9, MinAge, MaxAge, ObsAgeFreq)
res=GetChapmanRobsonMortalityResults(RecAssump=1, SpecRecAge=9, MinAge, MaxAge, ObsAgeFreq)
res
CatchCurveModel = 1 # Chapman Robson
NatMort = NA # Chapman Robson
RecAssump = 1 # Chapman Robson
MinFreq = NA # Chapman Robson
PlotAgeBasedCatchCurveResults_NormalSpace(RecAssump=1, SpecRecAge=9, MinFreq, MinAge, MaxAge, NatMort,
ObsAgeFreq, CatchCurveModel, MainLabel=NA,
xaxis_lab=NA, yaxis_lab=NA, xmax=NA, xint=NA,
ymax=NA, yint=NA, PlotCLs=T)
ObsAgeFreq = as.vector(unlist(Res$CatchSample))
res=GetChapmanRobsonMortalityResults(RecAssump=1, SpecRecAge=15, MinAge, MaxAge, ObsAgeFreq)
CatchCurveModel = 1 # Chapman Robson
NatMort = NA # Chapman Robson
RecAssump = 1 # Chapman Robson
MinFreq = NA # Chapman Robson
PlotAgeBasedCatchCurveResults_NormalSpace(RecAssump=1, SpecRecAge=15, MinFreq, MinAge, MaxAge, NatMort,
ObsAgeFreq, CatchCurveModel, MainLabel=NA,
xaxis_lab=NA, yaxis_lab=NA, xmax=NA, xint=NA,
ymax=NA, yint=NA, PlotCLs=T)
theta = 0.2
M = 0.3
par <- c(theta, M)
M     <- par[1]
M
theta <- par[-1]
theta
par
# Alex Hesp 24 March 2025
# Implementation of size-related movement model, as described in Hesp et al., 2004
# install.packages("cmna")
# install.packages("C:/~/L3Assess_0.1.0.tar.gz", source = TRUE, repos=NULL)
# install.packages("C:/~/WAFishBiology_0.1.0.tar.gz", source = TRUE, repos=NULL)
# install package from github
# library(devtools)
# devtools::install_github("SAlexHesp/L3AssessRPackage", build_vignettes=TRUE, force=TRUE)
# devtools::install_github("SAlexHesp/WAFishBiologyRPackage", build_vignettes=TRUE, force=TRUE)
rm(list=ls())
library(WAFishBiology)
library(L3Assess)
# Alex Hesp 24 March 2025
# Implementation of size-related movement model, as described in Hesp et al., 2004
# install.packages("cmna")
# install.packages("C:/~/L3Assess_0.1.0.tar.gz", source = TRUE, repos=NULL)
# install.packages("C:/~/WAFishBiology_0.1.0.tar.gz", source = TRUE, repos=NULL)
# install package from github
# library(devtools)
# devtools::install_github("SAlexHesp/L3AssessRPackage", build_vignettes=TRUE, force=TRUE)
# devtools::install_github("SAlexHesp/WAFishBiologyRPackage", build_vignettes=TRUE, force=TRUE)
rm(list=ls())
library(WAFishBiology)
library(L3Assess)
# Simulate data
SampleSize=5000 # sample size for retained catches (and same number for released fish, if an MLL is specified)
set.seed(123)
MaxAge = 30
TimeStep = 1 # model timestep (e.g. 1 = annual, 1/12 = monthly)
NatMort = 4.22/MaxAge
FishMort = 0.2
MaxLen = 1200
LenInc = 20
MLL=NA # (minimum legal length) # retention set to 1 for all lengths if MLL set to NA and retention parameters not specified
SelectivityType=2 # 1=selectivity inputted as vector, 2=asymptotic logistic selectivity curve
SelectivityAtLen = NA # selectivity vector
SelParams = c(300, 50) # L50, L95-L50 for gear selectivity
RetenParams = c(NA, NA) # L50, L95-L50 for retention
DiscMort = 0 # proportion of fish that die due to natural mortality
# single sex, von Bertalanffy
GrowthCurveType = 1 # 1 = von Bertalanffy, 2 = Schnute
DistnType = 1 # 1 = Multinomial, 2 = Dirichlet multinomial
Linf = 800
vbK = 0.2
CVSizeAtAge = 0.08
GrowthParams = c(Linf, vbK)
RefnceAges = NA
Res=SimLenAndAgeFreqData_EqMod(SampleSize, MaxAge, TimeStep, NatMort, FishMort, MaxLen, LenInc, MLL, SelectivityType,
SelParams, RetenParams, SelectivityAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, CVSizeAtAge)
ObsRetCatchFreqAtLen = Res$ObsRetCatchFreqAtLen
ObsDiscCatchFreqAtLen = NA # (or set to Res$ObsDiscCatchFreqAtLen)
RetenAtLen = NA # specify vector to fix, otherwise set to NA
midpt=Res$midpt
lbnd=Res$lbnd
ubnd=Res$ubnd
InitFishMort = 0.25 # specify starting parameters
InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform
InitL50 = 400
InitDelta = 100
params = c(InitFishMort_logit, log(InitL50), log(InitDelta))
# if estimating both selectivity and retention parameters
# InitL50Ret = 410
# InitDeltaRet = 60
# params = c(InitFishMort_logit, log(InitL50), log(InitDelta), log(InitL50Ret), log(InitDeltaRet))
FittedRes=GetLengthBasedCatchCurveResults(params, DistnType, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen,
lbnd, ubnd, midpt, SelectivityAtLen, RetenAtLen, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMort, TimeStep)
FittedRes$ParamEst
# library(devtools)
# from gz file - Alex debugging
# install.packages("C:/~/L3Assess_0.1.0.tar.gz", source = TRUE, repos=NULL)
# library(devtools)
# devtools::install_github("SAlexHesp/L3AssessRPackage", build_vignettes=TRUE, force=TRUE)
# devtools::install_github("SAlexHesp/WAFishBiologyRPackage", build_vignettes=TRUE, force=TRUE)
library(L3Assess)
# library(WAFishBiology)
# library(devtools)
# from gz file - Alex debugging
# install.packages("C:/~/L3Assess_0.1.0.tar.gz", source = TRUE, repos=NULL)
# library(devtools)
# devtools::install_github("SAlexHesp/L3AssessRPackage", build_vignettes=TRUE, force=TRUE)
# devtools::install_github("SAlexHesp/WAFishBiologyRPackage", build_vignettes=TRUE, force=TRUE)
library(L3Assess)
# library(WAFishBiology)
# # Simulate data
# SampleSize=5000 # sample size for retained catches (and same number for released fish, if an MLL is specified)
# set.seed(123)
# MaxAge = 30
# TimeStep = 1 # model timestep (e.g. 1 = annual, 1/12 = monthly)
# NatMortType = 2 # 1 = fixed, 2 = estimated with prior to allow for uncertainty
# NatMort = 4.22/MaxAge # natural mortality, in normal space
# NatMort_sd = 0.31 # standard deviation for natural mortality in log space. Set to NA if NatMortType = 1.
# FishMort = 0.2
# MaxLen = 1200
# LenInc = 20
# MLL=NA # (minimum legal length) # retention set to 1 for all lengths if MLL set to NA and retention parameters not specified
# SelectivityType=2 # 1=selectivity inputted as vector, 2=logistic selectivity params
# SelectivityAtLen = NA # selectivity vector
# SelParams = c(500, 50) # L50, L95-L50 for gear selectivity
# RetenParams = c(NA, NA) # L50, L95-L50 for retention
# DiscMort = 0 # proportion of fish that die due to natural mortality
# # single sex, von Bertalanffy
# DistnType = 1 # 1 = Multinomial, 2 = Dirichlet multinomial
# GrowthCurveType = 1 # 1 = von Bertalanffy, 2 = Schnute
# Linf = 800
# vbK = 0.2
# CVSizeAtAge = 0.08
# GrowthParams = c(Linf, vbK)
# RefnceAges = NA
# Res=SimLenAndAgeFreqData_EqMod(SampleSize, MaxAge, TimeStep, NatMort, FishMort, MaxLen, LenInc, MLL, SelectivityType,
#                                SelParams, RetenParams, SelectivityAtLen, DiscMort, GrowthCurveType, GrowthParams, RefnceAges, CVSizeAtAge)
# ObsRetCatchFreqAtLen = Res$ObsRetCatchFreqAtLen
# ObsDiscCatchFreqAtLen = NA # (or set to Res$ObsDiscCatchFreqAtLen)
# RetenAtLen = NA # retention at length
# midpt=Res$midpt
# lbnd=Res$lbnd
# ubnd=Res$ubnd
# InitFishMort = 0.25 # specify starting parameters
# InitFishMort_logit = log(InitFishMort/(1-InitFishMort)) # logit transform
# InitNatMort = 0.2
# InitL50 = 400
# InitDelta = 100
# params = c(InitFishMort_logit, log(InitNatMort), log(InitL50), log(InitDelta))
# FittedRes=GetLengthBasedCatchCurveResults(params, DistnType, GrowthCurveType, GrowthParams, RefnceAges, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt,
#                                           SelectivityAtLen, RetenAtLen, ObsDiscCatchFreqAtLen, DiscMort, CVSizeAtAge, MaxAge, NatMortType, NatMort, NatMort_sd, TimeStep)
#
# FittedRes$ParamEst
# FittedRes$ParamSims
# par(mfrow=c(2,2))
# hist(FittedRes$ParamSims[,1])
# hist(FittedRes$ParamSims[,2])
# hist(FittedRes$ParamSims[,3])
# hist(FittedRes$ParamSims[,4])
#
#
# sims=FittedRes$ResultsSummary$ParamSims
# # # using parametric resampling to get multiple estimates of F, M and selectivity parameters
# # # assuming the estimated values in the catch curve model conform to a multivariate
# # # normal distribution
# F.sim = FittedRes$ParamSims[,1]
# M.sim = FittedRes$ParamSims[,2]
# L50Ret.sim = FittedRes$ParamSims[,3]
# L95Ret.sim = FittedRes$ParamSims[,4]
#
#
# # **************
# # Plot for paper
# # **************
# par(mfcol=c(4,4), mar=c(2,2,2,2))
# plot(F.sim, F.sim, main=paste0("(F,F) r=",round(cor(F.sim,F.sim),2)))
# plot(F.sim, M.sim, main=paste0("(F,M) r=",round(cor(F.sim,M.sim),2)))
# plot(F.sim, L50Ret.sim, main=paste0("(F,L50) r=",round(cor(F.sim,L50Ret.sim),2)))
# plot(F.sim, L95Ret.sim, main=paste0("(F,L95) r=",round(cor(F.sim,L95Ret.sim),2)))
#
# plot(M.sim, F.sim, main=paste0("(M,F) r=",round(cor(M.sim,F.sim),2)))
# plot(M.sim, M.sim, main=paste0("(M,M) r=",round(cor(M.sim,M.sim),2)))
# plot(M.sim, L50Ret.sim, main=paste0("(M,L50) r=",round(cor(M.sim,L50Ret.sim),2)))
# plot(M.sim, L95Ret.sim, main=paste0("(M,L95) r=",round(cor(M.sim,L95Ret.sim),2)))
#
# plot(L50Ret.sim, F.sim, main=paste0("(L50,F) r=",round(cor(L50Ret.sim,F.sim),2)))
# plot(L50Ret.sim, M.sim, main=paste0("(L50,M) r=",round(cor(L50Ret.sim,M.sim),2)))
# plot(L50Ret.sim, L50Ret.sim, main=paste0("(L50,L50) r=",round(cor(L50Ret.sim,L50Ret.sim),2)))
# plot(L50Ret.sim, L95Ret.sim, main=paste0("(L50,L95) r=",round(cor(L50Ret.sim,L95Ret.sim),2)))
#
# plot(L95Ret.sim, F.sim, main=paste0("(L95,F) r=",round(cor(L95Ret.sim,F.sim),2)))
# plot(L95Ret.sim, M.sim, main=paste0("(L95,M)r=",round(cor(L95Ret.sim,M.sim),2)))
# plot(L95Ret.sim, L50Ret.sim, main=paste0("(L95,L50) r=",round(cor(L95Ret.sim,L50Ret.sim),2)))
# plot(L95Ret.sim, L95Ret.sim, main=paste0("(L95,L95) r=",round(cor(L95Ret.sim,L95Ret.sim),2)))
#
# par(mfrow=c(1,1))
# PlotLengthBasedCatchCurve_RetCatch(params, DistnType, MLL, SelectivityType, ObsRetCatchFreqAtLen, lbnd, ubnd, midpt,
#                                    SelectivityAtLen, RetenAtLen, ObsDiscCatchFreqAtLen, DiscMort, GrowthCurveType, GrowthParams,
#                                    RefnceAges, MaxAge, NatMortType, NatMort, NatMort_sd,  TimeStep, MainLabel=NA,
#                                    xaxis_lab=NA, yaxis_lab=NA, xmax=1500, xint=500,
#                                    ymax=0.15, yint=0.05, PlotCLs=TRUE, FittedRes, nReps=200)
#
#
# FittedRes$ParamEst
# Simulate data from Multinomial distribution (single sex)
set.seed(123)
MinAge = 1
MaxAge = 40
Ages = MinAge:MaxAge
NatMort = exp(1.46 - (1.01 * (log(MaxAge)))) # i.e. Hoenig's (1983) eqn for fish
FMort = 0.1
ZMort = FMort + NatMort
SelA50 = 6
SelA95 = 8
SampleSize = 1000 # required sample size. For 2 sex model, same sample size generated for each sex.
Res=SimAgeFreqData_EqMod(SampleSize, MinAge, MaxAge, SelA50, SelA95, NatMort, FMort)
ObsAgeFreq = unlist(as.vector(Res$CatchSample)) # input as vector for single sex model
# Specify catch curve model and required inputs for that model
nSexes = 1
DistnType = 1 # 1 = Multinomial, 2 = Dirichlet multinomial
NatMortType = 2 # 1 = fixed, 2 = estimated with prior
NatMort = exp(1.46 - (1.01 * (log(MaxAge))))
NatMort_sd = 0.31 # standard deviation for natural mortality in log space. Set to NA if NatMortType = 1
Init_FMort = 0.2
Init_NatMort = 0.2
Init_SelA50 = 5
Init_SelDelta = 2
# params = log(c(Init_FMort, Init_SelA50, Init_SelDelta))
params = log(c(Init_FMort, Init_NatMort, Init_SelA50, Init_SelDelta))
res=GetLogisticCatchCurveResults(params, nSexes, DistnType, NatMortType, NatMort, NatMort_sd, Ages, ObsAgeFreq)
res$ParamEst
res$ModelDiag$NatMort_PosteriorMeanLaplaceApprox
head(res$ParamSims)
# plot M prior vs posterior
post_median <- res$ParamEst[2,1]
post_CI_lower <- res$ParamEst[2,2]
post_CI_upper <- res$ParamEst[2,3]
post_meanlog <- log(post_median)
post_sdlog <- (log(post_CI_upper) - log(post_CI_lower)) / (2 * qnorm(0.975))
# plot M prior
par(mfrow=c(1,1),mar=c(5,4,2,2))
x <- seq(0, max(NatMort, post_CI_upper)*2, length.out = 1000)
y <- dlnorm(x, meanlog = log(NatMort), sdlog = NatMort_sd)
plot(x, y, ylim=c(0,1.3*max(y)), type = "l", lwd = 2, col = "blue", xlab = "M", ylab = "Probability",
main = "M prior vs posterior", bty='n', las=1, cex=0.8)
abline(v = NatMort, col = "blue", lty = 2)
# plot M posterior
lines(x, dlnorm(x, meanlog = post_meanlog, sdlog = post_sdlog),
lwd = 2, col = "red")
abline(v = post_median, col = "red", lty = 2)
abline(v = c(post_CI_lower, post_CI_upper), col = "darkgreen", lty = 3)
legend("topright",
legend = c("Prior density", "Prior median", "Posterior density", "Posterior median", "Posterior 95% CI"),
col = c("blue", "blue", "red", "red", "darkgreen"),
lty = c(1,2,1,2,3), lwd = c(2,1,2,1,1), bty='n', cex=0.8)
res$ParamEst
res$ModelDiag$NatMort_PosteriorMeanLaplaceApprox
NatMort
NatMort
params
exp(params[2])
# get natural mortality value
if (NatMortType == 1) NatMortVal = NatMort # natural mortality fixed
if (NatMortType == 2) NatMortVal = exp(params[2]) # natural mortality estimated with prior
NatMortVal
